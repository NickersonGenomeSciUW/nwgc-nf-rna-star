// Needed because github switched the default branch name to "main" from "master" and there is a hardcoded bug in nextflow
manifest.defaultBranch = 'main'

// Default all process(es) to use the parallel environment 'serial'
process.penv = "serial"

// Input
params.organism = "Homo sapiens"

// Defaults
params.chromosomes = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13", "14", "15", "16", "17", "18", "19", "20", "21", "22", "X", "Y", "M"]

// Analysis -- These are values for individual analysis to run: ["RSEM", "Junctions", "VCF", "QC", "BigWig"]
params.analysisToRun = ["All"]


process {
  debug = true
}

profiles {
	
	instanceSizeLow {
		process {
			// Map-merge
			withName: 'STAR' {
				memory = "2G"
				cpus = 1
			}
			withName: 'SAMBAMBA_SORT' {
				memory = "2G"
				cpus = 1
			}
			withName: 'CHECK_MAPPED_READ_COUNT' {
				memory = "2G"
			}
			
			// Analysis
			withName: 'RSEM' {
				memory = "2G"
				cpus = 1
			}
			withName: 'JUNCTIONS_BED' {
				memory = "2G"
			}
			withName: 'PICARD_MARK_DUPLICATES' {
				memory = "2G"
			}
			
			// Analysis using Picard Mark Duplicates output
			// BigWig
			withName: 'DEEPTOOLS_BAM_COVERAGE' {
				// memory and error strategy are defined in the process itself as they use task.attempt and task.exitStatus
				maxRetries = 1
			}
			
			// Call Variants
			withName: 'GATK_SPLIT_N_CIGAR_READS' {
				memory = 2G
			}
			withName: 'GATK_HAPLOTYPE_CALLER' {
				memory = 2G
			}
			withName: 'GATK_VARIANT_FILTRATION' {
				memory = 2G
			}
			
			// QC
			withName: 'PICARD_INSERT_SIZE' {
				memory = "2G"
			}
			withName: 'RNASEQC' {
				memory = "2G"
			}
		}
	}

	instanceSizeHigh {
		process {
			// Map-merge
			withName: 'STAR' {
				memory = "8G"
				cpus = 6
			}
			withName: 'SAMBAMBA_SORT' {
				memory = "2G"
				cpus = 6
			}
			withName: 'CHECK_MAPPED_READ_COUNT' {
				memory = "2G"
				cpus = 1
			}
			
			// Analysis
			withName: 'RSEM' {
				memory = "10G"
				cpus = 2
			}
			withName: 'JUNCTIONS_BED' {
				memory = "20G"
			}
			withName: 'PICARD_MARK_DUPLICATES' {
				memory = "20G"
			}
			
			// Analysis using Picard Mark Duplicates output
			// BigWig
			withName: 'DEEPTOOLS_BAM_COVERAGE' {
				// memory and error strategy are defined in the process itself as they use task.attempt and task.exitStatus
				maxRetries = 3
			}
			
			// Call Variants
			withName: 'GATK_SPLIT_N_CIGAR_READS' {
				memory = 12G
			}
			withName: 'GATK_HAPLOTYPE_CALLER' {
				memory = 12G
			}
			withName: 'GATK_VARIANT_FILTRATION' {
				memory = 4G
			}
			
			// QC
			withName: 'PICARD_INSERT_SIZE' {
				memory = "20G"
			}
			withName: 'RNASEQC' {
				memory = "20G"
			}
		}
	}

	executorLocal {
		// Executor
		executor.name = 'local'
	}

	executorGridEngine {
		// Executor
		executor.name = 'sge'
		executor.jobName = { "${task.label[0]}" + "_" + "${task.index}" }

		// Grid Engine
		clusterProject = "rna"
		defaultClusterOptions = "-S /bin/bash -P $clusterProject -m as -r yes -R yes";

		process {
			// Default cluster options with 1 hour run time for all processes
			clusterOptions = "$defaultClusterOptions -l d_rt=1:0:0"

			// Processes that have a different projected run time than the default
			withName: 'STAR' {
				modclusterOptions = "$defaultClusterOptions -l d_rt=2:0:0"
			}
			
		}
	}

	environmentCentOS7 {

		//  Modules
		initModules = "modules:modules-init:modules-gs"
		starModule = "STAR/2.6.1d"
		sambambaModule = "sambamba/0.6.8"
		samtoolsModule = "samtools/1.19"
		rsemPreReqModules = "gcc/8.1.0:python/3.6.4:bowtie2/2.2.3:R/3.5.1:STAR/2.6.1c:perl/5.24.0"
		rsemModule = "RSEM/1.3.1"
		picardModule = "picard/3.0.0"
		gccModule = "gcc/8.1.0"
		rModule = "R/3.5.1"
		rnaseqcModule = "rnaseqc/2.3.3"
		gatkModule = "GATK/4.2.0.0"
		tabixModule = "tabix/0.2.6"
		deepToolsModules = "python/3.6.4:deepTools/3.1.1"
		

		process {
			withName: 'STAR' {
				module = "${initModules}:${starModule}"
			}
			withName: 'SAMBAMBA_SORT' {
				module = "${initModules}:${sambambaModule}"
			}
			withName: 'CHECK_MAPPED_READ_COUNT' {
				module = "${initModules}:${samtoolsModule}"
			}
			withName: 'RSEM' {
				module = "${initModules}:${rsemPreReqModules}:${rsemModule}"
			}
			withName: 'JUNCTIONS_BED' {
				memory = "20G"
			}
			withName: 'PICARD_MARK_DUPLICATES' {
				module = "${initModules}:${picardModule}"
			}
			withName: 'DEEPTOOLS_BAM_COVERAGE' {
				module = "${initModules}:${deepToolsModules}"
			}
			withName: 'GATK_SPLIT_N_CIGAR_READS' {
				module = "${initModules}:${gatkModule}"
			}
			withName: 'GATK_HAPLOTYPE_CALLER' {
				module = "${initModules}:${gatkModule}"
			}
			withName: 'GATK_VARIANT_FILTRATION' {
				module = "${initModules}:${gatkModule}:${tabixModule}"
			}
			withName: 'PICARD_INSERT_SIZE' {
				module = "${initModules}:${picardModule}:${gccModule}:${rModule}"
			}
			withName: 'RNASEQC' {
				module = "${initModules}:${rnaseqcModule}"
			}
			
		}
	}

	environmentUbuntu22 {

		//  Modules
		initModules = "modules:modules-init:modules-gs"
		starModule = "STAR/2.6.1d"
		sambambaModule = "sambamba/0.6.8"
		samtoolsModule = "samtools/1.19"
		rsemModule = "RSEM/1.3.1"
		picardModule = "picard/3.0.0"
		rModule = "R/4.3.2"
		rnaseqcModule = "rnaseqc/2.3.3"
		gatkModules = "python/3.12.1:GATK/4.5.0.0"
		tabixModule = "tabix/0.2.6"
		deepToolsModules = "python/3.12.1:kiwisolver/1.4.5:deepTools/3.1.1"
		

		process {
			withName: 'STAR' {
				module = "${initModules}:${starModule}"
			}
			withName: 'SAMBAMBA_SORT' {
				module = "${initModules}:${sambambaModule}"
			}
			withName: 'CHECK_MAPPED_READ_COUNT' {
				module = "${initModules}:${samtoolsModule}"
			}
			withName: 'RSEM' {
				module = "${initModules}:${rsemModule}"
			}
			withName: 'JUNCTIONS_BED' {
				memory = "20G"
			}
			withName: 'PICARD_MARK_DUPLICATES' {
				module = "${initModules}:${picardModule}"
			}
			withName: 'DEEPTOOLS_BAM_COVERAGE' {
				module = "${initModules}:${deepToolsModules}"
			}
			withName: 'GATK_SPLIT_N_CIGAR_READS' {
				module = "${initModules}:${gatkModules}"
			}
			withName: 'GATK_HAPLOTYPE_CALLER' {
				module = "${initModules}:${gatkModules}"
			}
			withName: 'GATK_VARIANT_FILTRATION' {
				module = "${initModules}:${gatkModules}:${tabixModule}"
			}
			withName: 'PICARD_INSERT_SIZE' {
				module = "${initModules}:${picardModule}:${rModule}"
			}
			withName: 'RNASEQC' {
				module = "${initModules}:${rnaseqcModule}"
			}
			
		}
	}

	environmentContainer {
		process {
			withName: 'STAR' {
				container = "someContainerPath"
			}
		}
	}
}





